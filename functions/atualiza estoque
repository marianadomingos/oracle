CREATE OR REPLACE FUNCTION ATUALIZA_ESTOQUE (
    ID_PRODUTO_VENDIDO NUMBER,
    QTD_VENDIDA NUMBER
)
    RETURN NUMBER
    IS ESTOQUE_ATUAL NUMBER;
BEGIN
    -- Obtem o estoque atual do produto vendido
    SELECT ESTOQUE_DISPONIVEL INTO ESTOQUE_ATUAL
        FROM PRODUTOS P
        WHERE P.ID_PRODUTO = ID_PRODUTO_VENDIDO;

    -- Atualiza o estoque
    ESTOQUE_ATUAL := ESTOQUE_ATUAL - QTD_VENDIDA;

    -- Verifica se o produto possui saldo em estoque;
    IF ESTOQUE_ATUAL < 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Estoque insuficiente para a venda.');
    END IF;

    -- Atualiza o saldo na tabela produto
    UPDATE PRODUTOS P
     SET P.ESTOQUE_DISPONIVEL = ESTOQUE_ATUAL
     WHERE P.ID_PRODUTO = ID_PRODUTO_VENDIDO;

    -- Retorna o estoque atualizado
    RETURN ESTOQUE_ATUAL;
END;